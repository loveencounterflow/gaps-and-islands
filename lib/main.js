(function() {
  'use strict';
  var FSP, GUY, PATH, PGT, alert, clear, comment, debug, echo, help, info, inspect, join, log, plain, praise, read, rpr, unquote, urge, warn, whisper, write;

  //###########################################################################################################
  GUY = require('guy');

  ({alert, debug, help, info, plain, praise, urge, warn, whisper} = GUY.trm.get_loggers('GAPS-AND-ISLANDS'));

  ({rpr, inspect, echo, log} = GUY.trm);

  //...........................................................................................................
  PATH = require('node:path');

  FSP = (require('node:fs')).promises;

  PGT = require('paragate');

  join = function(me, ...P) {
    return PATH.resolve(PATH.join(me.base_path, ...P));
  };

  read = async function(me, path) {
    return (await FSP.readFile(path, {
      encoding: 'utf-8'
    }));
  };

  clear = async function(me) {
    return (await FSP.writeFile(me.target_path, ''));
  };

  write = async function(me, text) {
    return (await FSP.appendFile(me.target_path, text.toString()));
  };

  comment = function(text) {
    return '<!-- ' + (text.toString().replace(/--/g, '-_')) + ' -->\n';
  };

  unquote = function(text) {
    return text.replace(/^(['"])(.*)\1$/, '$2');
  };

  //-----------------------------------------------------------------------------------------------------------
  this.interpret_inserts = async function(me, token) {
    var d, dent, i, j, len, len1, line, path, ref, ref1, ref2;
    ref = PGT.HTML.grammar.parse(token.text);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^text':
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          ref2 = d.text.split(/\n/);
          for (j = 0, len1 = ref2.length; j < len1; j++) {
            line = ref2[j];
            await write(me, dent + line);
          }
          break;
        case '^tag':
          if (d.name !== 'insert') {
            await write(me, d.text);
            continue;
          }
          // await write me, comment d.text
          urge('^554^', `inserting ${d.atrs.src}`);
          path = PATH.join(me.base_path, unquote(d.atrs.src));
          await /* TAINT should be done by HTML parser */write(me, (await read(me, path)));
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.compile_readme = async function() {
    var d, dent, i, j, len, len1, line, me, ref, ref1, ref2;
    me = {};
    me.base_path = PATH.resolve(PATH.join(__dirname, '..'));
    me.source_path = join(me, 'main.md');
    me.target_path = join(me, 'README.md');
    me.source = (await read(me, me.source_path));
    //.........................................................................................................
    await clear(me);
    ref = PGT.RXWS.grammar.parse(me.source);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^blank':
          await write(me, d.text);
          break;
        case '^block':
          if (d.text.startsWith('<insert')) {
            await this.interpret_inserts(me, d);
            continue;
          }
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          ref2 = d.text.split(/\n/);
          for (j = 0, len1 = ref2.length; j < len1; j++) {
            line = ref2[j];
            await write(me, dent + d.text);
          }
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return me;
  };

  //###########################################################################################################
  if (module === require.main) {
    (async() => {
      return (await this.compile_readme());
    })();
  }

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21haW4uY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBO0VBQUE7QUFBQSxNQUFBLEdBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQSxJQUFBLEVBQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxHQUFBLEVBQUEsS0FBQSxFQUFBLE1BQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsSUFBQSxFQUFBLE9BQUEsRUFBQSxLQUFBOzs7RUFHQSxHQUFBLEdBQTRCLE9BQUEsQ0FBUSxLQUFSOztFQUM1QixDQUFBLENBQUUsS0FBRixFQUNFLEtBREYsRUFFRSxJQUZGLEVBR0UsSUFIRixFQUlFLEtBSkYsRUFLRSxNQUxGLEVBTUUsSUFORixFQU9FLElBUEYsRUFRRSxPQVJGLENBQUEsR0FRNEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFSLENBQW9CLGtCQUFwQixDQVI1Qjs7RUFTQSxDQUFBLENBQUUsR0FBRixFQUNFLE9BREYsRUFFRSxJQUZGLEVBR0UsR0FIRixDQUFBLEdBRzRCLEdBQUcsQ0FBQyxHQUhoQyxFQWJBOzs7RUFrQkEsSUFBQSxHQUE0QixPQUFBLENBQVEsV0FBUjs7RUFDNUIsR0FBQSxHQUE0QixDQUFFLE9BQUEsQ0FBUSxTQUFSLENBQUYsQ0FBcUIsQ0FBQzs7RUFDbEQsR0FBQSxHQUE0QixPQUFBLENBQVEsVUFBUjs7RUFDNUIsSUFBQSxHQUE0QixRQUFBLENBQUUsRUFBRixFQUFBLEdBQU0sQ0FBTixDQUFBO1dBQWlCLElBQUksQ0FBQyxPQUFMLENBQWEsSUFBSSxDQUFDLElBQUwsQ0FBVSxFQUFFLENBQUMsU0FBYixFQUF3QixHQUFBLENBQXhCLENBQWI7RUFBakI7O0VBQzVCLElBQUEsR0FBNEIsTUFBQSxR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IjpbIlxuJ3VzZSBzdHJpY3QnXG5cbiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xuR1VZICAgICAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUgJ2d1eSdcbnsgYWxlcnRcbiAgZGVidWdcbiAgaGVscFxuICBpbmZvXG4gIHBsYWluXG4gIHByYWlzZVxuICB1cmdlXG4gIHdhcm5cbiAgd2hpc3BlciB9ICAgICAgICAgICAgICAgPSBHVVkudHJtLmdldF9sb2dnZXJzICdHQVBTLUFORC1JU0xBTkRTJ1xueyBycHJcbiAgaW5zcGVjdFxuICBlY2hvXG4gIGxvZyAgICAgfSAgICAgICAgICAgICAgID0gR1VZLnRybVxuIy4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG5QQVRIICAgICAgICAgICAgICAgICAgICAgID0gcmVxdWlyZSAnbm9kZTpwYXRoJ1xuRlNQICAgICAgICAgICAgICAgICAgICAgICA9ICggcmVxdWlyZSAnbm9kZTpmcycgKS5wcm9taXNlc1xuUEdUICAgICAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUgJ3BhcmFnYXRlJ1xuam9pbiAgICAgICAgICAgICAgICAgICAgICA9ICggbWUsIFAuLi4gICkgLT4gUEFUSC5yZXNvbHZlIFBBVEguam9pbiBtZS5iYXNlX3BhdGgsIFAuLi5cbnJlYWQgICAgICAgICAgICAgICAgICAgICAgPSAoIG1lLCBwYXRoICApIC0+IGF3YWl0IEZTUC5yZWFkRmlsZSBwYXRoLCB7IGVuY29kaW5nOiAndXRmLTgnLCB9XG5jbGVhciAgICAgICAgICAgICAgICAgICAgID0gKCBtZSAgICAgICAgKSAtPiBhd2FpdCBGU1Aud3JpdGVGaWxlIG1lLnRhcmdldF9wYXRoLCAnJ1xud3JpdGUgICAgICAgICAgICAgICAgICAgICA9ICggbWUsIHRleHQgICkgLT4gYXdhaXQgRlNQLmFwcGVuZEZpbGUgbWUudGFyZ2V0X3BhdGgsIHRleHQudG9TdHJpbmcoKVxuY29tbWVudCAgICAgICAgICAgICAgICAgICA9ICggdGV4dCAgICAgICkgLT4gJzwhLS0gJyArICggdGV4dC50b1N0cmluZygpLnJlcGxhY2UgLy0tL2csICctXycgKSArICcgLS0+XFxuJ1xudW5xdW90ZSAgICAgICAgICAgICAgICAgICA9ICggdGV4dCAgICAgICkgLT4gdGV4dC5yZXBsYWNlIC9eKFsnXCJdKSguKilcXDEkLywgJyQyJ1xuXG4jLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbkBpbnRlcnByZXRfaW5zZXJ0cyA9ICggbWUsIHRva2VuICkgLT5cbiAgZm9yIGQgaW4gUEdULkhUTUwuZ3JhbW1hci5wYXJzZSB0b2tlbi50ZXh0XG4gICAgc3dpdGNoIGQuJGtleVxuICAgICAgd2hlbiAnPGRvY3VtZW50JywgJz5kb2N1bWVudCcgdGhlbiBudWxsXG4gICAgICB3aGVuICdedGV4dCdcbiAgICAgICAgZGVudCA9ICcgICcucmVwZWF0IGQubGV2ZWwgPyAwXG4gICAgICAgIGZvciBsaW5lIGluIGQudGV4dC5zcGxpdCAvXFxuL1xuICAgICAgICAgIGF3YWl0IHdyaXRlIG1lLCBkZW50ICsgbGluZVxuICAgICAgd2hlbiAnXnRhZydcbiAgICAgICAgdW5sZXNzIGQubmFtZSBpcyAnaW5zZXJ0J1xuICAgICAgICAgIGF3YWl0IHdyaXRlIG1lLCBkLnRleHRcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICAjIGF3YWl0IHdyaXRlIG1lLCBjb21tZW50IGQudGV4dFxuICAgICAgICB1cmdlICdeNTU0XicsIFwiaW5zZXJ0aW5nICN7ZC5hdHJzLnNyY31cIlxuICAgICAgICBwYXRoICA9IFBBVEguam9pbiBtZS5iYXNlX3BhdGgsIHVucXVvdGUgZC5hdHJzLnNyYyAjIyMgVEFJTlQgc2hvdWxkIGJlIGRvbmUgYnkgSFRNTCBwYXJzZXIgIyMjXG4gICAgICAgIGF3YWl0IHdyaXRlIG1lLCBhd2FpdCByZWFkIG1lLCBwYXRoXG4gICAgICBlbHNlIHRocm93IG5ldyBFcnJvciBcIl40Nzc2XiB1bmtub3duIHRva2VuICRrZXkgI3tycHIgZC4ka2V5fVwiXG4gIHJldHVybiBudWxsXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuQGNvbXBpbGVfcmVhZG1lID0gLT5cbiAgbWUgPSB7fVxuICBtZS5iYXNlX3BhdGggICAgPSBQQVRILnJlc29sdmUgUEFUSC5qb2luIF9fZGlybmFtZSwgJy4uJ1xuICBtZS5zb3VyY2VfcGF0aCAgPSBqb2luIG1lLCAnbWFpbi5tZCdcbiAgbWUudGFyZ2V0X3BhdGggID0gam9pbiBtZSwgJ1JFQURNRS5tZCdcbiAgbWUuc291cmNlICAgICAgID0gYXdhaXQgcmVhZCBtZSwgbWUuc291cmNlX3BhdGhcbiAgIy4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuICBhd2FpdCBjbGVhciBtZVxuICBmb3IgZCBpbiBQR1QuUlhXUy5ncmFtbWFyLnBhcnNlIG1lLnNvdXJjZVxuICAgIHN3aXRjaCBkLiRrZXlcbiAgICAgIHdoZW4gJzxkb2N1bWVudCcsICc+ZG9jdW1lbnQnIHRoZW4gbnVsbFxuICAgICAgd2hlbiAnXmJsYW5rJ1xuICAgICAgICBhd2FpdCB3cml0ZSBtZSwgZC50ZXh0XG4gICAgICB3aGVuICdeYmxvY2snXG4gICAgICAgIGlmIGQudGV4dC5zdGFydHNXaXRoICc8aW5zZXJ0J1xuICAgICAgICAgIGF3YWl0IEBpbnRlcnByZXRfaW5zZXJ0cyBtZSwgZFxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIGRlbnQgPSAnICAnLnJlcGVhdCBkLmxldmVsID8gMFxuICAgICAgICBmb3IgbGluZSBpbiBkLnRleHQuc3BsaXQgL1xcbi9cbiAgICAgICAgICBhd2FpdCB3cml0ZSBtZSwgZGVudCArIGQudGV4dFxuICAgICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IgXCJeNDc3Nl4gdW5rbm93biB0b2tlbiAka2V5ICN7cnByIGQuJGtleX1cIlxuICByZXR1cm4gbWVcblxuXG4jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcbmlmIG1vZHVsZSBpcyByZXF1aXJlLm1haW4gdGhlbiBkbyA9PlxuICBhd2FpdCBAY29tcGlsZV9yZWFkbWUoKVxuXG4iXX0=
