(function() {
  'use strict';
  var FSP, GUY, PATH, PGT, alert, clear, comment, debug, echo, help, info, inspect, join, log, plain, praise, read, rpr, unquote, urge, warn, whisper, write;

  //###########################################################################################################
  GUY = require('guy');

  ({alert, debug, help, info, plain, praise, urge, warn, whisper} = GUY.trm.get_loggers('GAPS-AND-ISLANDS'));

  ({rpr, inspect, echo, log} = GUY.trm);

  //...........................................................................................................
  PATH = require('node:path');

  FSP = (require('node:fs')).promises;

  PGT = require('paragate');

  join = function(me, ...P) {
    return PATH.resolve(PATH.join(me.base_path, ...P));
  };

  read = async function(me, path) {
    return (await FSP.readFile(path, {
      encoding: 'utf-8'
    }));
  };

  clear = async function(me) {
    return (await FSP.writeFile(me.target_path, ''));
  };

  write = async function(me, text) {
    return (await FSP.appendFile(me.target_path, text.toString()));
  };

  comment = function(text) {
    return '<!-- ' + (text.toString().replace(/--/g, '-_')) + ' -->\n';
  };

  unquote = function(text) {
    return text.replace(/^(['"])(.*)\1$/, '$2');
  };

  //-----------------------------------------------------------------------------------------------------------
  this.interpret_inserts = async function(me, token) {
    var d, dent, i, j, len, len1, line, path, ref, ref1, ref2;
    ref = PGT.HTML.grammar.parse(token.text);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^text':
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          ref2 = d.text.split(/\n/);
          for (j = 0, len1 = ref2.length; j < len1; j++) {
            line = ref2[j];
            await write(me, dent + line);
          }
          break;
        case '^tag':
          if (d.name !== 'insert') {
            await write(me, d.text);
            continue;
          }
          // await write me, comment d.text
          urge('^554^', `inserting ${d.atrs.src}`);
          path = PATH.join(me.base_path, unquote(d.atrs.src));
          await /* TAINT should be done by HTML parser */write(me, (await read(me, path)));
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.compile_readme = async function() {
    var d, dent, i, j, len, len1, line, me, ref, ref1, ref2;
    me = {};
    me.base_path = PATH.resolve(PATH.join(__dirname, '..'));
    me.source_path = join(me, 'main.md');
    me.target_path = join(me, 'README.md');
    me.source = (await read(me, me.source_path));
    //.........................................................................................................
    await clear(me);
    ref = PGT.RXWS.grammar.parse(me.source);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^blank':
          await write(me, d.text);
          break;
        case '^block':
          if (d.text.startsWith('<insert')) {
            await this.interpret_inserts(me, d);
            continue;
          }
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          ref2 = d.text.split(/\n/);
          for (j = 0, len1 = ref2.length; j < len1; j++) {
            line = ref2[j];
            await write(me, dent + line);
          }
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return me;
  };

  //###########################################################################################################
  if (module === require.main) {
    (async() => {
      return (await this.compile_readme());
    })();
  }

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21haW4uY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBO0VBQUE7QUFBQSxNQUFBLEdBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQSxJQUFBLEVBQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxHQUFBLEVBQUEsS0FBQSxFQUFBLE1BQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsSUFBQSxFQUFBLE9BQUEsRUFBQSxLQUFBOzs7RUFHQSxHQUFBLEdBQTRCLE9BQUEsQ0FBUSxLQUFSOztFQUM1QixDQUFBLENBQUUsS0FBRixFQUNFLEtBREYsRUFFRSxJQUZGLEVBR0UsSUFIRixFQUlFLEtBSkYsRUFLRSxNQUxGLEVBTUUsSUFORixFQU9FLElBUEYsRUFRRSxPQVJGLENBQUEsR0FRNEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFSLENBQW9CLGtCQUFwQixDQVI1Qjs7RUFTQSxDQUFBLENBQUUsR0FBRixFQUNFLE9BREYsRUFFRSxJQUZGLEVBR0UsR0FIRixDQUFBLEdBRzRCLEdBQUcsQ0FBQyxHQUhoQyxFQWJBOzs7RUFrQkEsSUFBQSxHQUE0QixPQUFBLENBQVEsV0FBUjs7RUFDNUIsR0FBQSxHQUE0QixDQUFFLE9BQUEsQ0FBUSxTQUFSLENBQUYsQ0FBcUIsQ0FBQzs7RUFDbEQsR0FBQSxHQUE0QixPQUFBLENBQVEsVUFBUjs7RUFDNUIsSUFBQSxHQUE0QixRQUFBLENBQUUsRUFBRixFQUFBLEdBQU0sQ0FBTixDQUFBO1dBQWlCLElBQUksQ0FBQyxPQUFMLENBQWEsSUFBSSxDQUFDLElBQUwsQ0FBVSxFQUFFLENBQUMsU0FBYixFQUF3QixHQUFBLENBQXhCLENBQWI7RUFBakI7O0VBQzVCLElBQUEsR0FBNEIsTUFBQSxR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IHN0cmljdCdcblxuIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXG5HVVkgICAgICAgICAgICAgICAgICAgICAgID0gcmVxdWlyZSAnZ3V5J1xueyBhbGVydFxuICBkZWJ1Z1xuICBoZWxwXG4gIGluZm9cbiAgcGxhaW5cbiAgcHJhaXNlXG4gIHVyZ2VcbiAgd2FyblxuICB3aGlzcGVyIH0gICAgICAgICAgICAgICA9IEdVWS50cm0uZ2V0X2xvZ2dlcnMgJ0dBUFMtQU5ELUlTTEFORFMnXG57IHJwclxuICBpbnNwZWN0XG4gIGVjaG9cbiAgbG9nICAgICB9ICAgICAgICAgICAgICAgPSBHVVkudHJtXG4jLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi5cblBBVEggICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlICdub2RlOnBhdGgnXG5GU1AgICAgICAgICAgICAgICAgICAgICAgID0gKCByZXF1aXJlICdub2RlOmZzJyApLnByb21pc2VzXG5QR1QgICAgICAgICAgICAgICAgICAgICAgID0gcmVxdWlyZSAncGFyYWdhdGUnXG5qb2luICAgICAgICAgICAgICAgICAgICAgID0gKCBtZSwgUC4uLiAgKSAtPiBQQVRILnJlc29sdmUgUEFUSC5qb2luIG1lLmJhc2VfcGF0aCwgUC4uLlxucmVhZCAgICAgICAgICAgICAgICAgICAgICA9ICggbWUsIHBhdGggICkgLT4gYXdhaXQgRlNQLnJlYWRGaWxlIHBhdGgsIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIH1cbmNsZWFyICAgICAgICAgICAgICAgICAgICAgPSAoIG1lICAgICAgICApIC0+IGF3YWl0IEZTUC53cml0ZUZpbGUgbWUudGFyZ2V0X3BhdGgsICcnXG53cml0ZSAgICAgICAgICAgICAgICAgICAgID0gKCBtZSwgdGV4dCAgKSAtPiBhd2FpdCBGU1AuYXBwZW5kRmlsZSBtZS50YXJnZXRfcGF0aCwgdGV4dC50b1N0cmluZygpXG5jb21tZW50ICAgICAgICAgICAgICAgICAgID0gKCB0ZXh0ICAgICAgKSAtPiAnPCEtLSAnICsgKCB0ZXh0LnRvU3RyaW5nKCkucmVwbGFjZSAvLS0vZywgJy1fJyApICsgJyAtLT5cXG4nXG51bnF1b3RlICAgICAgICAgICAgICAgICAgID0gKCB0ZXh0ICAgICAgKSAtPiB0ZXh0LnJlcGxhY2UgL14oWydcIl0pKC4qKVxcMSQvLCAnJDInXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuQGludGVycHJldF9pbnNlcnRzID0gKCBtZSwgdG9rZW4gKSAtPlxuICBmb3IgZCBpbiBQR1QuSFRNTC5ncmFtbWFyLnBhcnNlIHRva2VuLnRleHRcbiAgICBzd2l0Y2ggZC4ka2V5XG4gICAgICB3aGVuICc8ZG9jdW1lbnQnLCAnPmRvY3VtZW50JyB0aGVuIG51bGxcbiAgICAgIHdoZW4gJ150ZXh0J1xuICAgICAgICBkZW50ID0gJyAgJy5yZXBlYXQgZC5sZXZlbCA/IDBcbiAgICAgICAgZm9yIGxpbmUgaW4gZC50ZXh0LnNwbGl0IC9cXG4vXG4gICAgICAgICAgYXdhaXQgd3JpdGUgbWUsIGRlbnQgKyBsaW5lXG4gICAgICB3aGVuICdedGFnJ1xuICAgICAgICB1bmxlc3MgZC5uYW1lIGlzICdpbnNlcnQnXG4gICAgICAgICAgYXdhaXQgd3JpdGUgbWUsIGQudGV4dFxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgICMgYXdhaXQgd3JpdGUgbWUsIGNvbW1lbnQgZC50ZXh0XG4gICAgICAgIHVyZ2UgJ141NTReJywgXCJpbnNlcnRpbmcgI3tkLmF0cnMuc3JjfVwiXG4gICAgICAgIHBhdGggID0gUEFUSC5qb2luIG1lLmJhc2VfcGF0aCwgdW5xdW90ZSBkLmF0cnMuc3JjICMjIyBUQUlOVCBzaG91bGQgYmUgZG9uZSBieSBIVE1MIHBhcnNlciAjIyNcbiAgICAgICAgYXdhaXQgd3JpdGUgbWUsIGF3YWl0IHJlYWQgbWUsIHBhdGhcbiAgICAgIGVsc2UgdGhyb3cgbmV3IEVycm9yIFwiXjQ3NzZeIHVua25vd24gdG9rZW4gJGtleSAje3JwciBkLiRrZXl9XCJcbiAgcmV0dXJuIG51bGxcblxuIy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5AY29tcGlsZV9yZWFkbWUgPSAtPlxuICBtZSA9IHt9XG4gIG1lLmJhc2VfcGF0aCAgICA9IFBBVEgucmVzb2x2ZSBQQVRILmpvaW4gX19kaXJuYW1lLCAnLi4nXG4gIG1lLnNvdXJjZV9wYXRoICA9IGpvaW4gbWUsICdtYWluLm1kJ1xuICBtZS50YXJnZXRfcGF0aCAgPSBqb2luIG1lLCAnUkVBRE1FLm1kJ1xuICBtZS5zb3VyY2UgICAgICAgPSBhd2FpdCByZWFkIG1lLCBtZS5zb3VyY2VfcGF0aFxuICAjLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uXG4gIGF3YWl0IGNsZWFyIG1lXG4gIGZvciBkIGluIFBHVC5SWFdTLmdyYW1tYXIucGFyc2UgbWUuc291cmNlXG4gICAgc3dpdGNoIGQuJGtleVxuICAgICAgd2hlbiAnPGRvY3VtZW50JywgJz5kb2N1bWVudCcgdGhlbiBudWxsXG4gICAgICB3aGVuICdeYmxhbmsnXG4gICAgICAgIGF3YWl0IHdyaXRlIG1lLCBkLnRleHRcbiAgICAgIHdoZW4gJ15ibG9jaydcbiAgICAgICAgaWYgZC50ZXh0LnN0YXJ0c1dpdGggJzxpbnNlcnQnXG4gICAgICAgICAgYXdhaXQgQGludGVycHJldF9pbnNlcnRzIG1lLCBkXG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgZGVudCA9ICcgICcucmVwZWF0IGQubGV2ZWwgPyAwXG4gICAgICAgIGZvciBsaW5lIGluIGQudGV4dC5zcGxpdCAvXFxuL1xuICAgICAgICAgIGF3YWl0IHdyaXRlIG1lLCBkZW50ICsgbGluZVxuICAgICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IgXCJeNDc3Nl4gdW5rbm93biB0b2tlbiAka2V5ICN7cnByIGQuJGtleX1cIlxuICByZXR1cm4gbWVcblxuXG4jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcbmlmIG1vZHVsZSBpcyByZXF1aXJlLm1haW4gdGhlbiBkbyA9PlxuICBhd2FpdCBAY29tcGlsZV9yZWFkbWUoKVxuXG4iXX0=
