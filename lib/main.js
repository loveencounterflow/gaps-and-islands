(function() {
  'use strict';
  var FSP, GUY, PATH, PGT, alert, clear, comment, debug, echo, help, info, inspect, join, log, plain, praise, read, rpr, unquote, urge, warn, whisper, write;

  //###########################################################################################################
  GUY = require('guy');

  ({alert, debug, help, info, plain, praise, urge, warn, whisper} = GUY.trm.get_loggers('GAPS-AND-ISLANDS'));

  ({rpr, inspect, echo, log} = GUY.trm);

  //...........................................................................................................
  PATH = require('node:path');

  FSP = (require('node:fs')).promises;

  PGT = require('paragate');

  join = function(me, ...P) {
    return PATH.resolve(PATH.join(me.base_path, ...P));
  };

  read = async function(me, path) {
    return (await FSP.readFile(path, {
      encoding: 'utf-8'
    }));
  };

  clear = async function(me) {
    return (await FSP.writeFile(me.target_path, ''));
  };

  write = async function(me, text) {
    return (await FSP.appendFile(me.target_path, text.toString()));
  };

  comment = function(text) {
    return '<!-- ' + (text.toString().replace(/--/g, '-_')) + ' -->\n';
  };

  unquote = function(text) {
    return text.replace(/^(['"])(.*)\1$/, '$2');
  };

  //-----------------------------------------------------------------------------------------------------------
  this.interpret_inserts = async function(me, token) {
    var d, dent, i, len, path, ref, ref1;
    ref = PGT.HTML.grammar.parse(token.text);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^text':
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          await write(me, dent + d.text);
          break;
        case '^tag':
          if (d.name !== 'insert') {
            await write(me, d.text);
            continue;
          }
          // await write me, comment d.text
          urge('^554^', `inserting ${d.atrs.src}`);
          path = PATH.join(me.base_path, unquote(d.atrs.src));
          await /* TAINT should be done by HTML parser */write(me, (await read(me, path)));
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.compile_readme = async function() {
    var d, dent, i, len, me, ref, ref1;
    me = {};
    me.base_path = PATH.resolve(PATH.join(__dirname, '..'));
    me.source_path = join(me, 'main.md');
    me.target_path = join(me, 'README.md');
    me.source = (await read(me, me.source_path));
    //.........................................................................................................
    await clear(me);
    ref = PGT.RXWS.grammar.parse(me.source);
    for (i = 0, len = ref.length; i < len; i++) {
      d = ref[i];
      switch (d.$key) {
        case '<document':
        case '>document':
          null;
          break;
        case '^blank':
          await write(me, d.text);
          break;
        case '^block':
          if (d.text.startsWith('<insert')) {
            await this.interpret_inserts(me, d);
            continue;
          }
          dent = '  '.repeat((ref1 = d.level) != null ? ref1 : 0);
          await write(me, dent + d.text);
          break;
        default:
          throw new Error(`^4776^ unknown token $key ${rpr(d.$key)}`);
      }
    }
    return me;
  };

  //###########################################################################################################
  if (module === require.main) {
    (async() => {
      return (await this.compile_readme());
    })();
  }

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21haW4uY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBO0VBQUE7QUFBQSxNQUFBLEdBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsS0FBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQSxJQUFBLEVBQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxHQUFBLEVBQUEsS0FBQSxFQUFBLE1BQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsSUFBQSxFQUFBLE9BQUEsRUFBQSxLQUFBOzs7RUFHQSxHQUFBLEdBQTRCLE9BQUEsQ0FBUSxLQUFSOztFQUM1QixDQUFBLENBQUUsS0FBRixFQUNFLEtBREYsRUFFRSxJQUZGLEVBR0UsSUFIRixFQUlFLEtBSkYsRUFLRSxNQUxGLEVBTUUsSUFORixFQU9FLElBUEYsRUFRRSxPQVJGLENBQUEsR0FRNEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFSLENBQW9CLGtCQUFwQixDQVI1Qjs7RUFTQSxDQUFBLENBQUUsR0FBRixFQUNFLE9BREYsRUFFRSxJQUZGLEVBR0UsR0FIRixDQUFBLEdBRzRCLEdBQUcsQ0FBQyxHQUhoQyxFQWJBOzs7RUFrQkEsSUFBQSxHQUE0QixPQUFBLENBQVEsV0FBUjs7RUFDNUIsR0FBQSxHQUE0QixDQUFFLE9BQUEsQ0FBUSxTQUFSLENBQUYsQ0FBcUIsQ0FBQzs7RUFDbEQsR0FBQSxHQUE0QixPQUFBLENBQVEsVUFBUjs7RUFDNUIsSUFBQSxHQUE0QixRQUFBLENBQUUsRUFBRixFQUFBLEdBQU0sQ0FBTixDQUFBO1dBQWlCLElBQUksQ0FBQyxPQUFMLENBQWEsSUFBSSxDQUFDLElBQUwsQ0FBVSxFQUFFLENBQUMsU0FBYixFQUF3QixHQUFBLENBQXhCLENBQWI7RUFBakI7O0VBQzVCLElBQUEsR0FBNEIsTUFBQSxR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QUNsQixFQUFFLENBQUMsTUFBSCxHQUFrQixDQUFBLE1BQU0sSUFBQSxDQUFLLEVBQUwsRUFBUyxFQUFFLENBQUMsV0FBWixDQUFOLEVBSnBCOztJQU1FLE1BQU0sS0FBQSxDQUFNLEVBQU47QUFDTjtJQUFBLEtBQUEscUNBQUE7O0FBQ0UsY0FBTyxDQUFDLENBQUMsSUFBVDtBQUFBLGFBQ08sV0FEUDtBQUFBLGFBQ29CLFdBRHBCO1VBQ3FDO0FBQWpCO0FBRHBCLGFBRU8sUUFGUDtVQUdJLE1BQU0sS0FBQSxDQUFNLEVBQU4sRUFBVSxDQUFDLENBQUMsSUFBWjtBQURIO0FBRlAsYUFJTyxRQUpQO1VBS0ksSUFBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVAsQ0FBa0IsU0FBbEIsQ0FBSDtZQUNFLE1BQU0sSUFBQyxDQUFBLGlCQUFELENBQW1CLEVBQW5CLEVBQXVCLENBQXZCO0FBQ04scUJBRkY7O1VBR0EsSUFBQSxHQUFPLElBQUksQ0FBQyxNQUFMLG1DQUFzQixDQUF0QjtVQUNQLE1BQU0sS0FBQSxDQUFNLEVBQU4sRUFBVSxJQUFBLEdBQU8sQ0FBQyxDQUFDLElBQW5CO0FBTEg7QUFKUDtVQVVPLE1BQU0sSUFBSSxLQUFKLENBQVUsQ0FBQSwwQkFBQSxDQUFBLENBQTZCLEdBQUEsQ0FBSSxDQUFDLENBQUMsSUFBTixDQUE3QixDQUFBLENBQVY7QUFWYjtJQURGO0FBWUEsV0FBTztFQXBCUyxFQWhEbEI7OztFQXdFQSxJQUFHLE1BQUEsS0FBVSxPQUFPLENBQUMsSUFBckI7SUFBa0MsQ0FBQSxLQUFBLENBQUEsQ0FBQSxHQUFBO2FBQ2hDLENBQUEsTUFBTSxJQUFDLENBQUEsY0FBRCxDQUFBLENBQU47SUFEZ0MsQ0FBQSxJQUFsQzs7QUF4RUEiLCJzb3VyY2VzQ29udGVudCI6WyJcbid1c2Ugc3RyaWN0J1xuXG4jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcbkdVWSAgICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlICdndXknXG57IGFsZXJ0XG4gIGRlYnVnXG4gIGhlbHBcbiAgaW5mb1xuICBwbGFpblxuICBwcmFpc2VcbiAgdXJnZVxuICB3YXJuXG4gIHdoaXNwZXIgfSAgICAgICAgICAgICAgID0gR1VZLnRybS5nZXRfbG9nZ2VycyAnR0FQUy1BTkQtSVNMQU5EUydcbnsgcnByXG4gIGluc3BlY3RcbiAgZWNob1xuICBsb2cgICAgIH0gICAgICAgICAgICAgICA9IEdVWS50cm1cbiMuLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuUEFUSCAgICAgICAgICAgICAgICAgICAgICA9IHJlcXVpcmUgJ25vZGU6cGF0aCdcbkZTUCAgICAgICAgICAgICAgICAgICAgICAgPSAoIHJlcXVpcmUgJ25vZGU6ZnMnICkucHJvbWlzZXNcblBHVCAgICAgICAgICAgICAgICAgICAgICAgPSByZXF1aXJlICdwYXJhZ2F0ZSdcbmpvaW4gICAgICAgICAgICAgICAgICAgICAgPSAoIG1lLCBQLi4uICApIC0+IFBBVEgucmVzb2x2ZSBQQVRILmpvaW4gbWUuYmFzZV9wYXRoLCBQLi4uXG5yZWFkICAgICAgICAgICAgICAgICAgICAgID0gKCBtZSwgcGF0aCAgKSAtPiBhd2FpdCBGU1AucmVhZEZpbGUgcGF0aCwgeyBlbmNvZGluZzogJ3V0Zi04JywgfVxuY2xlYXIgICAgICAgICAgICAgICAgICAgICA9ICggbWUgICAgICAgICkgLT4gYXdhaXQgRlNQLndyaXRlRmlsZSBtZS50YXJnZXRfcGF0aCwgJydcbndyaXRlICAgICAgICAgICAgICAgICAgICAgPSAoIG1lLCB0ZXh0ICApIC0+IGF3YWl0IEZTUC5hcHBlbmRGaWxlIG1lLnRhcmdldF9wYXRoLCB0ZXh0LnRvU3RyaW5nKClcbmNvbW1lbnQgICAgICAgICAgICAgICAgICAgPSAoIHRleHQgICAgICApIC0+ICc8IS0tICcgKyAoIHRleHQudG9TdHJpbmcoKS5yZXBsYWNlIC8tLS9nLCAnLV8nICkgKyAnIC0tPlxcbidcbnVucXVvdGUgICAgICAgICAgICAgICAgICAgPSAoIHRleHQgICAgICApIC0+IHRleHQucmVwbGFjZSAvXihbJ1wiXSkoLiopXFwxJC8sICckMidcblxuIy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5AaW50ZXJwcmV0X2luc2VydHMgPSAoIG1lLCB0b2tlbiApIC0+XG4gIGZvciBkIGluIFBHVC5IVE1MLmdyYW1tYXIucGFyc2UgdG9rZW4udGV4dFxuICAgIHN3aXRjaCBkLiRrZXlcbiAgICAgIHdoZW4gJzxkb2N1bWVudCcsICc+ZG9jdW1lbnQnIHRoZW4gbnVsbFxuICAgICAgd2hlbiAnXnRleHQnXG4gICAgICAgIGRlbnQgPSAnICAnLnJlcGVhdCBkLmxldmVsID8gMFxuICAgICAgICBhd2FpdCB3cml0ZSBtZSwgZGVudCArIGQudGV4dFxuICAgICAgd2hlbiAnXnRhZydcbiAgICAgICAgdW5sZXNzIGQubmFtZSBpcyAnaW5zZXJ0J1xuICAgICAgICAgIGF3YWl0IHdyaXRlIG1lLCBkLnRleHRcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICAjIGF3YWl0IHdyaXRlIG1lLCBjb21tZW50IGQudGV4dFxuICAgICAgICB1cmdlICdeNTU0XicsIFwiaW5zZXJ0aW5nICN7ZC5hdHJzLnNyY31cIlxuICAgICAgICBwYXRoICA9IFBBVEguam9pbiBtZS5iYXNlX3BhdGgsIHVucXVvdGUgZC5hdHJzLnNyYyAjIyMgVEFJTlQgc2hvdWxkIGJlIGRvbmUgYnkgSFRNTCBwYXJzZXIgIyMjXG4gICAgICAgIGF3YWl0IHdyaXRlIG1lLCBhd2FpdCByZWFkIG1lLCBwYXRoXG4gICAgICBlbHNlIHRocm93IG5ldyBFcnJvciBcIl40Nzc2XiB1bmtub3duIHRva2VuICRrZXkgI3tycHIgZC4ka2V5fVwiXG4gIHJldHVybiBudWxsXG5cbiMtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuQGNvbXBpbGVfcmVhZG1lID0gLT5cbiAgbWUgPSB7fVxuICBtZS5iYXNlX3BhdGggICAgPSBQQVRILnJlc29sdmUgUEFUSC5qb2luIF9fZGlybmFtZSwgJy4uJ1xuICBtZS5zb3VyY2VfcGF0aCAgPSBqb2luIG1lLCAnbWFpbi5tZCdcbiAgbWUudGFyZ2V0X3BhdGggID0gam9pbiBtZSwgJ1JFQURNRS5tZCdcbiAgbWUuc291cmNlICAgICAgID0gYXdhaXQgcmVhZCBtZSwgbWUuc291cmNlX3BhdGhcbiAgIy4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLlxuICBhd2FpdCBjbGVhciBtZVxuICBmb3IgZCBpbiBQR1QuUlhXUy5ncmFtbWFyLnBhcnNlIG1lLnNvdXJjZVxuICAgIHN3aXRjaCBkLiRrZXlcbiAgICAgIHdoZW4gJzxkb2N1bWVudCcsICc+ZG9jdW1lbnQnIHRoZW4gbnVsbFxuICAgICAgd2hlbiAnXmJsYW5rJ1xuICAgICAgICBhd2FpdCB3cml0ZSBtZSwgZC50ZXh0XG4gICAgICB3aGVuICdeYmxvY2snXG4gICAgICAgIGlmIGQudGV4dC5zdGFydHNXaXRoICc8aW5zZXJ0J1xuICAgICAgICAgIGF3YWl0IEBpbnRlcnByZXRfaW5zZXJ0cyBtZSwgZFxuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIGRlbnQgPSAnICAnLnJlcGVhdCBkLmxldmVsID8gMFxuICAgICAgICBhd2FpdCB3cml0ZSBtZSwgZGVudCArIGQudGV4dFxuICAgICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IgXCJeNDc3Nl4gdW5rbm93biB0b2tlbiAka2V5ICN7cnByIGQuJGtleX1cIlxuICByZXR1cm4gbWVcblxuXG4jIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyNcbmlmIG1vZHVsZSBpcyByZXF1aXJlLm1haW4gdGhlbiBkbyA9PlxuICBhd2FpdCBAY29tcGlsZV9yZWFkbWUoKVxuXG4iXX0=
